<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="SW-Precache is a great Service Worker tool from Google. It is a node module designed to be integrated into your build process and to generate a service worker for you. Though you can use sw-precache o">
<meta name="keywords" content="Web,🇬🇧,PWA">
<meta property="og:type" content="article">
<meta property="og:title" content="How does SW-Precache works?">
<meta property="og:url" content="http://yoursite.com/2019/07/04/2017-05-28-sw-precache/index.html">
<meta property="og:site_name" content="Johnson&#39;s Blog">
<meta property="og:description" content="SW-Precache is a great Service Worker tool from Google. It is a node module designed to be integrated into your build process and to generate a service worker for you. Though you can use sw-precache o">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-07-04T03:56:32.682Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How does SW-Precache works?">
<meta name="twitter:description" content="SW-Precache is a great Service Worker tool from Google. It is a node module designed to be integrated into your build process and to generate a service worker for you. Though you can use sw-precache o">





  
  
  <link rel="canonical" href="http://yoursite.com/2019/07/04/2017-05-28-sw-precache/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>How does SW-Precache works? | Johnson's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Johnson's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/04/2017-05-28-sw-precache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Johnson Lin">
      <meta itemprop="description" content="jfds ifd ewrerw iok.">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Johnson's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">How does SW-Precache works?

              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-04 11:56:32" itemprop="dateCreated datePublished" datetime="2019-07-04T11:56:32+08:00">2019-07-04</time>
            </span>
          

          

          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://github.com/GoogleChrome/sw-precache" target="_blank" rel="noopener"><em>SW-Precache</em></a> <em>is a great Service Worker tool from Google. It is a node module designed to be</em> <em>integrated</em> <em>into your build process and to generate a service worker for you.</em> <em>Though</em> <em>you can use sw-precache out of the box, you might still wonder what happens under the hood. There you go, this article is written for you!</em></p>
<blockquote>
<p>This post was first published at <a href="https://medium.com/@Huxpro/how-does-sw-precache-works-2d99c3d3c725" target="_blank" rel="noopener">Medium</a></p>
</blockquote>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>The core files involving in sw-precache are mainly three:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service-worker.tmpl  </span><br><span class="line">lib/  </span><br><span class="line"> ├ sw-precache.js  </span><br><span class="line"> └ functions.js</span><br></pre></td></tr></table></figure>

<p><code>sw-precache.js</code> is the main entry of the module. It reads the configuration, processes parameters, populates the <code>service-worker.tmpl</code> template and writes the result into specified file. And<code>functions.js</code> is just a module containing bunch of external functions which would be all injected into the generated service worker file as helpers.</p>
<p>Since the end effect of sw-precache is performed by the generated service worker file in the runtime, a easy way to get an idea of what happens is by checking out source code inside <code>service-worker.tmpl</code> . It’s not hard to understand the essentials and I will help you.</p>
<h2 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h2><p>The generated service worker file (let’s call it <code>sw.js</code> for instance) get configuration by text interpolation when <code>sw-precache.js</code> populating <code>service-worker.tmpl</code> .</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service-worker.tmpl  </span></span><br><span class="line"><span class="keyword">var</span> precacheConfig = <span class="xml"><span class="tag">&lt;<span class="name">%=</span> <span class="attr">precacheConfig</span> %&gt;</span>;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">// sw.js  </span></span><br><span class="line"><span class="xml">var precacheConfig = [  </span></span><br><span class="line"><span class="xml">  ["js/a.js", "3cb4f0"],   </span></span><br><span class="line"><span class="xml">  ["css/b.css", "c5a951"]  </span></span><br><span class="line"><span class="xml">]</span></span><br></pre></td></tr></table></figure>

<p>It’s not difficult to see that it’s a list of relative urls and MD5 hashes. In fact, one thing that <code>sw-precache.js</code> do in the build time is to calculate hash of each file that it asked to “precache” from <code>staticFileGlobs</code> parameter.</p>
<p>In <code>sw.js</code>, <code>precacheConfig</code> would be transformed into a ES6 Map with structure <code>Map {absoluteUrl =&gt; cacheKey}</code> as below. Noticed that I omit the origin part (e.g. <code>http://localhost</code>) for short.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; urlToCacheKeys  </span><br><span class="line">&lt; <span class="built_in">Map</span>(<span class="number">2</span>) &#123;  </span><br><span class="line">  <span class="string">"http.../js/a.js"</span> =&gt; <span class="string">"http.../js/a.js?_sw-precache=3cb4f0"</span>,   </span><br><span class="line">  <span class="string">"http.../css/b.js"</span> =&gt; <span class="string">"http.../css/b.css?_sw-precache=c5a951"</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Instead of using raw URL as the cache key, sw-precache append a <code>_sw-precache=[hash]</code> to the end of each URL when populating, updating its cache and even fetching these subresouces. Those <code>_sw-precache=[hash]</code> are what we called <strong>cache-busting parameter*</strong>. It can prevent service worker from responding and caching out-of-date responses found in browsers’ HTTP cache indefinitely.</p>
<p>Because each build would re-calculate hashes and re-generate a new <code>sw.js</code> with new <code>precacheConfig</code> containing those new hashes, <code>sw.js</code> can now determine the version of each subresources thus decide what part of its cache needs a update. <strong>This is pretty similar with what we commonly do when realizing long-term caching with webpack or gulp-rev, to do a byte-diff ahead of runtime.</strong></p>
<p>*: Developer can opt out this behaviour with <code>dontCacheBustUrlsMatching</code> option if they set HTTP caching headers right. More details on <a href="https://jakearchibald.com/2016/caching-best-practices/" target="_blank" rel="noopener">Jake’s Post</a>.</p>
<h2 id="On-Install"><a href="#On-Install" class="headerlink" title="On Install"></a>On Install</h2><blockquote>
<p>ServiceWorker gives you an install event. You can use this to get stuff ready, stuff that must be ready before you handle other events.</p>
</blockquote>
<p>During the <code>install</code> lifecycle, <code>sw.js</code> open the cache and get started to populate its cache. One cool thing that it does for you is its <strong>incremental update</strong> mechanism.</p>
<p>Sw-precache would search each cache key (the values of <code>urlsToCacheKeys</code>) in the <code>cachedUrls</code>, a ES6 Set containing URLs of all requests indexed from current version of cache, and only <code>fetch</code> and <code>cache.put</code> resources couldn’t be found in cache, i.e, never be cached before, thus reuse cached resources as much as possible.</p>
<p>If you can not fully understand it, don’t worry. We will recap it later, now let’s move on.</p>
<h2 id="On-Activate"><a href="#On-Activate" class="headerlink" title="On Activate"></a>On Activate</h2><blockquote>
<p>Once a new ServiceWorker has installed &amp; a previous version isn’t being used, the new one activates, and you get an <code>activate</code> event. Because the old version is out of the way, it’s a good time to handle schema migrations in IndexedDB and also delete unused caches.</p>
</blockquote>
<p>During activation phase, <code>sw.js</code> would compare all existing requests in the cache, named <code>existingRequests</code> (noticed that it now contains resources just cached on installation phase) with <code>setOfExpectedUrls</code>, a ES6 Set from the values of <code>urlsToCacheKeys</code>. And delete any requests not matching from cache.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sw.js</span></span><br><span class="line">existingRequests.map(<span class="function"><span class="keyword">function</span>(<span class="params">existingRequest</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!setOfExpectedUrls.has(existingRequest.url)) &#123;</span><br><span class="line">    <span class="keyword">return</span> cache.delete(existingRequest);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="On-Fetch"><a href="#On-Fetch" class="headerlink" title="On Fetch"></a>On Fetch</h2><p>Although the comments in source code have elaborated everything well, I wanna highlight some points during the request intercepting duration.</p>
<h3 id="Should-Respond"><a href="#Should-Respond" class="headerlink" title="Should Respond?"></a>Should Respond?</h3><p>Firstly, we need to determine whether this request was included in our “pre-caching list”. If it was, this request should have been pre-fetched and pre-cached thus we can respond it directly from cache.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sw.js*  </span></span><br><span class="line"><span class="keyword">var</span> url = event.request.url      </span><br><span class="line">shouldRespond = urlsToCacheKeys.has(url);</span><br></pre></td></tr></table></figure>

<p>Noticed that we are matching raw URLs (e.g. <code>http://localhost/js/a.js</code>) instead of the hashed ones. It prevent us from calculating hashes at runtime, which would have a significant cost. And since we have kept the relationship in <code>urlToCacheKeys</code> it’s easy to index the hashed one out.</p>
<p><em>* In real cases, sw-precache would take <code>ignoreUrlParametersMatching</code> and <code>directoryIndex</code> options into consideration.</em></p>
<h3 id="Navigation-Fallback"><a href="#Navigation-Fallback" class="headerlink" title="Navigation Fallback"></a>Navigation Fallback</h3><p>One interesting feature that sw-precache provided is <code>navigationFallback</code>(previously <code>defaultRoute</code>), which detect navigation request and respond a preset fallback HTML document when the URL of navigation request did not exist in <code>urlsToCacheKeys</code>.</p>
<p>It is presented for SPA using History API based routing, allowing responding arbitrary URLs with one single HTML entry defined in <code>navigationFallback</code>, kinda reimplementing a Nginx rewrite in service worker*. Do noticed that service worker only intercept document (navigation request) inside its scope (and any resources referenced in those documents of course). So navigation towards outside scope would not be effected.</p>
<p><em>* <code>navigateFallbackWhitelist</code> can be provided to limit the “rewrite” scope.</em></p>
<h3 id="Respond-from-Cache"><a href="#Respond-from-Cache" class="headerlink" title="Respond from Cache"></a>Respond from Cache</h3><p>Finally, we get the appropriate cache key (the hashed URL) by raw URL with <code>urlsToCacheKeys</code> and invoke <code>event.respondWith()</code> to respond requests from cache directly. Done!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sw.js*</span></span><br><span class="line">event.respondWith(</span><br><span class="line">  caches.open(cacheName).then(<span class="function"><span class="params">cache</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cache.match(urlsToCacheKeys.get(url))</span><br><span class="line">      .then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (response) <span class="keyword">return</span> response;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><em>* The code was “ES6-fied” with error handling part removed.</em></p>
<h2 id="Cache-Management-Recap"><a href="#Cache-Management-Recap" class="headerlink" title="Cache Management Recap"></a>Cache Management Recap</h2><p>That’s recap the cache management part with a full lifecycle simulation.</p>
<h3 id="The-first-build"><a href="#The-first-build" class="headerlink" title="The first build"></a>The first build</h3><p>Supposed we are in the very first load, the <code>cachedUrls</code> would be a empty set thus all subresources listed to be pre-cached would be fetched and put into cache on SW install time.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cachedUrls  </span></span><br><span class="line"><span class="built_in">Set</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// urlToCacheKeys  </span></span><br><span class="line"><span class="built_in">Map</span>(<span class="number">2</span>) &#123;  </span><br><span class="line">  <span class="string">"http.../js/a.js"</span> =&gt; <span class="string">"http.../js/a.js?_sw-precache=3cb4f0"</span>,   </span><br><span class="line">  <span class="string">"http.../css/b.js"</span> =&gt; <span class="string">"http.../css/b.css?_sw-precache=c5a951"</span>  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SW Network Logs  </span></span><br><span class="line">[sw] GET a.js?_sw-precache=<span class="number">3</span>cb4f0      </span><br><span class="line">[sw] GET b.css?_sw-precache=c5a951</span><br></pre></td></tr></table></figure>

<p>After that, it will start to control the page immediately because the <code>sw.js</code> would call <code>clients.claim()</code> by default. It means the <code>sw.js</code> will start to intercept and try to serve future fetches from caches, so it’s good for performance.</p>
<p>In the second load, all subresouces have been cached and will be served directly from cache. So none requests are sent from <code>sw.js</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cachedUrls  </span></span><br><span class="line"><span class="built_in">Set</span>(<span class="number">2</span>) &#123;  </span><br><span class="line">  <span class="string">"http.../js/a.js? _sw-precache=3cb4f0"</span>,   </span><br><span class="line">  <span class="string">"http.../css/b.css? _sw-precache=c5a951"</span>  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// urlToCacheKeys  </span></span><br><span class="line"><span class="built_in">Map</span>(<span class="number">2</span>) &#123;  </span><br><span class="line">  <span class="string">"http.../js/a.js"</span> =&gt; <span class="string">"http.../js/a.js? _sw-precache=3cb4f0"</span>,   </span><br><span class="line">  <span class="string">"http.../css/b.js"</span> =&gt; <span class="string">"http.../css/b.css? _sw-precache=c5a951"</span>  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SW Network Logs  </span></span><br><span class="line"><span class="comment">// Empty</span></span><br></pre></td></tr></table></figure>

<h3 id="The-second-build"><a href="#The-second-build" class="headerlink" title="The second build"></a>The second build</h3><p>Once we create a byte-diff of our subresouces (e.g., we modify <code>a.js</code> to a new version with hash value <code>d6420f</code>) and re-run the build process, a new version of <code>sw.js</code> would be also generated.</p>
<p>The new <code>sw.js</code> would run alongside with the existing one, and start its own installation phase.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cachedUrls  </span></span><br><span class="line"><span class="built_in">Set</span>(<span class="number">2</span>) &#123;  </span><br><span class="line">  <span class="string">"http.../js/a.js? _sw-precache=3cb4f0"</span>,   </span><br><span class="line">  <span class="string">"http.../css/b.css? _sw-precache=c5a951"</span>  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// urlToCacheKeys  </span></span><br><span class="line"><span class="built_in">Map</span>(<span class="number">2</span>) &#123;  </span><br><span class="line">  <span class="string">"http.../js/a.js"</span> =&gt; <span class="string">"http.../js/a.js? _sw-precache=d6420f"</span>,   </span><br><span class="line">  <span class="string">"http.../css/b.js"</span> =&gt; <span class="string">"http.../css/b.css? _sw-precache=c5a951"</span>  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SW Network Logs  </span></span><br><span class="line"> [sw] GET a.js?_sw-precache=d6420f</span><br></pre></td></tr></table></figure>

<p>This time, <code>sw.js</code> see that there is a new version of <code>a.js</code> requested, so it fetch <code>/js/a.js?_sw-precache=d6420f</code>  and put the response into cache. In fact, we have two versions of <code>a.js</code> in cache at the same time in this moment.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// what's in cache?</span></span><br><span class="line">http.../js/a.js?_sw-precache=<span class="number">3</span>cb4f0</span><br><span class="line">http.../js/a.js?_sw-precache=d6420f</span><br><span class="line">http.../css/b.css?_sw-precache=c5a951</span><br></pre></td></tr></table></figure>

<p>By default, <code>sw.js</code> generated by sw-precache would call <code>self.skipWaiting</code> so it would take over the page and move onto activating phase immediately.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// existingRequests</span></span><br><span class="line">http.../js/a.js?_sw-precache=<span class="number">3</span>cb4f0</span><br><span class="line">http.../js/a.js?_sw-precache=d6420f</span><br><span class="line">http.../css/b.css?_sw-precache=c5a951</span><br><span class="line"></span><br><span class="line"><span class="comment">// setOfExpectedUrls</span></span><br><span class="line"><span class="built_in">Set</span>(<span class="number">2</span>) &#123;</span><br><span class="line">  <span class="string">"http.../js/a.js?_sw-precache=d6420f"</span>, </span><br><span class="line">  <span class="string">"http.../css/b.css?_sw-precache=c5a951"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the one deleted</span></span><br><span class="line">http.../js/a.js?_sw-precache=<span class="number">3</span>cb4f0</span><br></pre></td></tr></table></figure>

<p>By comparing existing requests in the cache with set of expected ones, the old version of <code>a.js</code> would be deleted from cache. This ensure there is only one version of our site’s resources each time.</p>
<p>That’s it! We finish the simulation successfully.</p>
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>As its name implied, sw-precache is designed specifically for the needs of precaching some critical static resources. It only does one thing but does it well. I’d love to give you some opinionated suggestions but you decide whether your requirements suit it or not.</p>
<h3 id="Precaching-is-NOT-free"><a href="#Precaching-is-NOT-free" class="headerlink" title="Precaching is NOT free"></a>Precaching is NOT free</h3><p>So don’t precached everything. Sw-precache use a <a href="https://jakearchibald.com/2014/offline-cookbook/#on-install-as-a-dependency" target="_blank" rel="noopener">“On Install — as a dependency”</a> strategy for your precache configs. A huge list of requests would delay the time service worker finishing installing and, in addition, wastes users’ bandwidth and disk space.</p>
<p>For instance, if you wanna build a offline-capable blogs. You had better not include things like <code>&#39;posts/*.html</code> in <code>staticFileGlobs</code>. It would be a huge disaster to data-sensitive people if you have hundreds of posts. Use a Runtime Caching instead.</p>
<h3 id="“App-Shell”"><a href="#“App-Shell”" class="headerlink" title="“App Shell”"></a>“App Shell”</h3><blockquote>
<p>A helpful analogy is to think of your App Shell as the code and resources that would be published to an app store for a native iOS or Android application.</p>
</blockquote>
<p>Though I always consider that the term “App Shell” is too narrow to cover its actual usages now, It is widely used and commonly known. I personally prefer calling them <strong>“Web Installation Package”</strong> straightforward because they can be truly installed into users’ disks and our web app can boot up directly from them in any network environments. The only difference between “Web Installation Package” and iOS/Android App is that we need strive to limit it within a reasonable size.</p>
<p>Precaching is perfect for this kinda resources such as entry html, visual placeholders, offline pages etc., because they can be static in one version, small-sized, and most importantly, part of critical rendering path. We wanna put first meaningful paint ASAP to our user thus we precache them to eliminate HTTP roundtrip time.</p>
<p>BTW, if you are using HTML5 Application Cache before, sw-precache is really a perfect replacement because it can cover nearly all use cases the App Cache provide.</p>
<h3 id="This-is-not-the-end"><a href="#This-is-not-the-end" class="headerlink" title="This is not the end"></a>This is not the end</h3><p>Sw-precache is just one of awesome tools that can help you build service worker. If you are planing to add some service worker power into your website, Don’t hesitate to checkout sw-toolbox, sw-helper (a new tool Google is working on) and many more from communities.</p>
<p>That’s all. Wish you enjoy!</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/Web/" rel="tag"># Web</a>
          
            <a href="/tags/🇬🇧/" rel="tag"># 🇬🇧</a>
          
            <a href="/tags/PWA/" rel="tag"># PWA</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/04/2017-04-06-html-document/" rel="next" title="「知乎」如何理解 <code>document</code> 对象是 <code>HTMLDocument</code> 的实例？">
                <i class="fa fa-chevron-left"></i> 「知乎」如何理解 <code>document</code> 对象是 <code>HTMLDocument</code> 的实例？
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/04/2017-10-06-css-complaints/" rel="prev" title="「知乎」为什么 CSS 这么难学？">
                「知乎」为什么 CSS 这么难学？ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Johnson Lin">
            
              <p class="site-author-name" itemprop="name">Johnson Lin</p>
              <div class="site-description motion-element" itemprop="description">jfds ifd ewrerw iok.</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/yourname" title="GitHub &rarr; https://github.com/yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:yourname@gmail.com" title="E-Mail &rarr; mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Initialization"><span class="nav-number">2.</span> <span class="nav-text">Initialization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#On-Install"><span class="nav-number">3.</span> <span class="nav-text">On Install</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#On-Activate"><span class="nav-number">4.</span> <span class="nav-text">On Activate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#On-Fetch"><span class="nav-number">5.</span> <span class="nav-text">On Fetch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Should-Respond"><span class="nav-number">5.1.</span> <span class="nav-text">Should Respond?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Navigation-Fallback"><span class="nav-number">5.2.</span> <span class="nav-text">Navigation Fallback</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Respond-from-Cache"><span class="nav-number">5.3.</span> <span class="nav-text">Respond from Cache</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cache-Management-Recap"><span class="nav-number">6.</span> <span class="nav-text">Cache Management Recap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-first-build"><span class="nav-number">6.1.</span> <span class="nav-text">The first build</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-second-build"><span class="nav-number">6.2.</span> <span class="nav-text">The second build</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusions"><span class="nav-number">7.</span> <span class="nav-text">Conclusions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Precaching-is-NOT-free"><span class="nav-number">7.1.</span> <span class="nav-text">Precaching is NOT free</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#“App-Shell”"><span class="nav-number">7.2.</span> <span class="nav-text">“App Shell”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#This-is-not-the-end"><span class="nav-number">7.3.</span> <span class="nav-text">This is not the end</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Johnson Lin</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>




  
  <script src="/js/scrollspy.js?v=7.2.0"></script>
<script src="/js/post-details.js?v=7.2.0"></script>



  


  <script src="/js/next-boot.js?v=7.2.0"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
